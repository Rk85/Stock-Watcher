<div class="container-fluid" id="invest_portfolio">
  <div class="row-fluid">
    <div class="span6 portfolio">
      {% block portfolio_header %}{% endblock portfolio_header %}
      <div class="row-fluid">
        {% block portfolio_max_gainer %}{% endblock portfolio_max_gainer %}
        {% block portfolio_max_loser %}{% endblock portfolio_max_loser %}
      </div>
    </div>
    <div data-bind="visible: showToday" class="span6 portfolio-graph" id="portfolioGraph_today">
    </div>
    <div data-bind="visible: !showToday()" class="span6 portfolio-graph" id="portfolioGraph_total">
    </div>
  </div>
  <div class="row-fluid trans-div">
    {% block profile_select_div %}{% endblock profile_select_div %}
    {% block portfolio_trans %}{% endblock portfolio_trans %}
  </div>
</div>
{% include "utils/modals.html" %}

<script>
(function (stockWatcher, $) {
  
  var profileCompanyDetails = function profileCompanyRows(data, parent) {
    var self = this;
    self.data = data || {};
    self.profileId =  self.data.profileId || 1;
    self.companyId = self.data.id;
    self.companyTransShow = ko.observable(false);
    self.transactionTotal = ko.observable(Application.formats.portfolioTransDetail(self.data));
    self.transactionDetails = ko.observableArray(
      ko.utils.arrayForEach(self.data.transaction_details || [],  function (transaction) {
        return Application.formats.portfolioTransDetail(transaction);
      })  || []
    );
    self.addNewTrans = function addNewTrans(newTransDetails) {
      $.each(newTransDetails, function (index, trans) {
        self.transactionDetails.push(Application.formats.portfolioTransDetail(trans));
      });
    };
    self.transactionAction = function transactionAction(actionId, rowData, event) {
      if (actionId === Application.staticData.ADD) {
        var newTransData = {
          companyName: self.transactionTotal().companyName,
          onSave: self.addNewTrans
        };
        parent.transModalDetails(new stockWatcher.transModals(newTransData, parent));
      } else if (actionId === Application.staticData.EDIT) {
        rowData.headerName = 'Edit Transaction';
        rowData.isEdit = true;
        parent.transModalDetails(new stockWatcher.transModals(rowData, parent));
      } else if (actionId === Application.staticData.DEL) {
        Application.showAlert({
          msg: "Do you want to delete this Transaction?",
          callBack: function (result) {
            if (result) {
              self.transactionDetails.remove(rowData);
            }
          }
        });
      }
    };
  }

  stockWatcher.portFolio = function portFolio(data) {
    var self = this;
    self.userName = ko.observable('Guest');
    self.showToday = ko.observable(true);
    self.changePortfolioType = function () {
      self.showToday(!self.showToday());
      if ( self.showToday()) {
        self.drawChart("today");
      }
      else{
        self.drawChart("total");
      }
    };
    self.todayDataPoints = ko.observableArray();
    self.totalDataPoints = ko.observableArray();
    self.drawChart = function (type){
      if (type == "today") {
        var options = {
          graphArgs: {
            title :{ text: "Today Net Profit"},      
            data: [{ type: "line", xValueType: "dateTime"}],
            axisX: { title: "chart updates every 3 secs"},
            axisY:{ prefix: 'Rs', includeZero: false}, 
          },
          dataLength: 5,
          updateInterval: 3000,
          dataPoints: self.todayDataPoints
        }
        Application.graph.Init("portfolioGraph_today", options)
      }
      if (type == "total") {
        var options = {
          graphArgs: {
            title :{ text: "OverAll Net Profit"},      
            data: [{ type: "line", xValueType: "dateTime"}],
            axisX: { title: "chart updates every 3 secs"},
            axisY:{ prefix: 'Rs', includeZero: false}, 
          },
          dataLength: 5,
          updateInterval: 3000,
          dataPoints: self.totalDataPoints
        }
        Application.graph.Init("portfolioGraph_total", options)
      }
      
    }
    self.drawChart("today");
    self.todayDetails = ko.observable(Application.formats.portfolioTotalDetails({}));
    self.totalDetails = ko.observable(Application.formats.portfolioTotalDetails({}));
    self.portFolioDetails = ko.computed(function () {
      if ( self.showToday() ){
        return  {
            linkName: 'Today',
            linkValue: self.todayDetails
          };
      }
      else {
        return {
            linkName: 'OverAll',
            linkValue: self.totalDetails
          };
      }
    });
    self.availableProfiles = ko.observableArray([
      {
        id: 1,
        name: 'test'
      },
      {
        id: 2,
        name: 'test2'
      }
    ]);
    self.selectedProfile = ko.observable(self.availableProfiles()[0]);
    self.availableRefreshRates = ko.observableArray([
      {
        id: 1,
        name: '2 minutes'
      },
      {
        id: 2,
        name: '5 minutes'
      }
    ]);
    self.selectedRefreshRate = ko.observable();
    self.totalProfileTableRows = ko.observableArray([
      new profileCompanyDetails({id: 1, companyName: "NAME1", profileId: 1}, self),
      new profileCompanyDetails({id: 2, companyName: "NAME3", profileId: 1}, self),
      new profileCompanyDetails({id: 3, companyName: "NAME2", profileId: 2}, self)
    ]);
    self.selectedProfileRows = ko.computed(function () {
      if (self.selectedProfile()) {
        return ko.utils.arrayFilter(self.totalProfileTableRows() || [], function (row) {
          return row.profileId === self.selectedProfile().id;
        });
      }
      return [];
    });
    self.transModalDetails = ko.observable(new stockWatcher.transModals({}, self));
    self.companyAction = function companyAction(actionId, rowData, event) {
      if (actionId === Application.staticData.ADD) {
        alert('Add New Company');
      } else if (actionId === Application.staticData.DEL) {
        var result = Application.showAlert({
          msg: "Do you want to delete this Company?",
          callBack: function (result) {
            if (result) {
              self.totalProfileTableRows.remove(
                ko.utils.arrayFirst(self.totalProfileTableRows() || [],
                  function (profileRow) {
                    return profileRow.companyId === rowData.companyId;
                  })
              );
            }
          }
        });
      }
    };
  };
}(Application.namespace("Application.stockWatcher"), jQuery));

var applyFormBindings = function (data, tab_id) {
  var model = new Application.stockWatcher.portFolio(data);
  ko.applyBindings(model, $(tab_id)[0]);
};
</script>
