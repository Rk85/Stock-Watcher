<div class="container-fluid" id="invest_portfolio">
  <div class="row-fluid">
    <div class="span6 portfolio">
      {% block portfolio_header %}{% endblock portfolio_header %}
      <div class="row-fluid">
        {% block portfolio_max_gainer %}{% endblock portfolio_max_gainer %}
        {% block portfolio_max_loser %}{% endblock portfolio_max_loser %}
      </div>
    </div>
  </div>
  <div class="row-fluid trans-div">
    {% block profile_select_div %}{% endblock profile_select_div %}
    {% block portfolio_trans %}{% endblock portfolio_trans %}
  </div>
</div>
{% include "utils/modals.html" %}

<script>

(function (stockWatcher, $) {

  var formatTotalDetails = function formatTotalDetails(details) {
    return {
      totalValue: details.total_value || "877,234",
      totalChange: details.total_change || "+10000",
      changePercent: details.change_percent || "(+15.0%)",
      valueInc: details.value_inc || true,
      maxGainerName: details.max_gainer_name || 'Company Name',
      maxGainerValue: details.max_gainer_value || 30.50,
      maxGainerChange: details.max_gainer_change || "+5.50",
      maxGainerChangePercent: details.max_gainer_percent || "(+5.50)",
      maxLoserName: details.max_loser_name || 'Company Name',
      maxLoserValue: details.max_loser_value || 30.50,
      maxLoserChange: details.max_loser_change || "+5.50",
      maxLoserChangePercent: details.max_loser_percent || "(+5.50)"
    }
  };

  var profileCompanyDetails = function profileCompanyRows(data, parent){
      var self = this;
      self.data = data || {};
      self.formatDetails = function formatDetails(details){
        return {
                companyName: details.company_name || 'Company Name',
                invPrice: details.inv_price || 20,
                quantity: details.quantity || 100,
                invTotalAmount: details.inv_total_amount || 5000,
                livePrice: details.live_price || 60,
                todayChange: details.today_change || 10,
                todayGain: details.today_gain || 50,
                todayPercentage: details.today_percentage || '2%',
                totalChange: details.total_change || 10,
                totalGain: details.total_gain || 50,
                totalPercentage: details.total_percent || '2%',
                companyId: details.id || '',
                comments: details.comments || '',
                invDate: details.inv_date || '03/03/2014'
        }
      };
      self.profileId =  self.data.profile_id || 1,
      self.companyId = self.data.id;
      self.transactionTotal = ko.observable(self.formatDetails(self.data));
      self.transactionDetails = ko.observableArray(
        ko.utils.arrayForEach(self.data.transaction_details || [],  function(transaction){
          return self.formatDetails(transaction);
        })  || []
      );
      // Sample insert to verify the UI
      self.transactionDetails.push(self.formatDetails({}));
      self.transactionDetails.push(self.formatDetails({}));
      self.transactionDetails.push(self.formatDetails({}));
      self.companyTransShow = ko.observable(false);
      self.transactionAction = function transactionAction(actionId, rowData, event) {
        if (actionId === 1) {
          alert('Add Transaction')
          var newTransData = {companyName: self.transactionTotal().companyName};
          parent.transModalDetails(new stockWatcher.transModals(newTransData, parent));
        } else if (actionId === 2){
          alert('Edit Transaction')
          parent.transModalDetails(new stockWatcher.transModals(rowData, parent));
        } else if (actionId === 0) {
          var result = Application.showAlert({
              msg: "Do you want to delete this Transaction?",
              callBack: function (result) {
                if (result) {
                  self.transactionDetails.remove(rowData);
                }
              }
          });
        }
      };
  }

  stockWatcher.portFolio = function portFolio(data) {
    var self = this;
    self.userName = ko.observable('Guest');
    self.showToday = ko.observable(true);
    self.changePortfolioType = function () {
      self.showToday(!self.showToday());
    };
    self.todayDetails = ko.observable(formatTotalDetails({}));
    self.totalDetails = ko.observable(formatTotalDetails({}));
    self.portFolioDetails = ko.computed(function () {
      return self.showToday() ?
          {
            linkName: 'Today',
            linkValue: self.todayDetails
          } :
          {
            linkName: 'OverAll',
            linkValue: self.totalDetails
          };
    });
    self.availableProfiles = ko.observableArray([
      {
        id: 1,
        name: 'test'
      },
      {
        id: 2,
        name: 'test2'
      }
    ]);
    self.selectedProfile = ko.observable(self.availableProfiles()[0]);
    self.availableRefreshRates = ko.observableArray([
      {
        id: 1,
        name: '2 minutes'
      },
      {
        id: 2,
        name: '5 minutes'
      }
    ]);
    self.selectedRefreshRate = ko.observable();
    self.totalProfileTableRows = ko.observableArray([
      new profileCompanyDetails({id: 1, company_name: "NAME1", profile_id: 1}, self),
      new profileCompanyDetails({id: 2, company_name: "NAME3", profile_id: 1}, self),
      new profileCompanyDetails({id: 3, company_name: "NAME2", profile_id: 2}, self)
    ]);
    self.selectedProfileRows = ko.computed(function () {
      if (self.selectedProfile()) {
        return ko.utils.arrayFilter(self.totalProfileTableRows() || [], function (row) {
          return row.profileId === self.selectedProfile().id;
        });
      }
      return [];
    });
    self.availableQoutes = ko.observableArray([
    ]);
    self.transModalDetails = ko.observable(new stockWatcher.transModals({}, self));
    self.companyAction = function companyAction(actionId, rowData, event) {
        if (actionId === 1) {
          alert('Add New Company')
        } else if (actionId === 0) {
          var result = Application.showAlert({
              msg: "Do you want to delete this Company?",
              callBack: function (result) {
                if (result) {
                  self.totalProfileTableRows.remove(
                    ko.utils.arrayFirst(self.totalProfileTableRows() || [], function(profileRow){
                      return profileRow.companyId === rowData.companyId;
                    })
                  )
              }
            }
          });
        }
    };
  }
}(Application.namespace("Application.stockWatcher"), jQuery));

var applyFormBindings = function (data, tab_id) {
  var model = new Application.stockWatcher.portFolio(data);
  ko.applyBindings(model, $(tab_id)[0]);
};
</script>
